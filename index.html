<!-- index.html (CORRIGIDO) -->
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat com Luna 游눘</title>
    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <div id="chat-container">
      <h1>Conversando com Luna 游눘</h1>
      <div id="chat-log"></div>
      <section id="historico-container" style="display: none">
        <h2>Hist칩rico de Conversas 游눫</h2>
        <ul id="lista-sessoes"></ul>
        <div
          id="visualizacao-conversa-detalhada"
          style="margin-top: 20px"
        ></div>
      </section>

      <!-- Bot칚o para alternar entre chat e hist칩rico -->
      <button id="btn-historico">Ver Hist칩rico</button>
      <button id="btn-voltar-chat" style="display: none">Voltar ao Chat</button>
      <div id="status"></div>
      <form id="prompt-form" style="width: 100%">
        <div id="input-area">
          <textarea
            id="prompt-input"
            rows="1"
            placeholder="Digite sua mensagem..."
          ></textarea>
          <button id="submit-button" type="submit">Enviar</button>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("prompt-form");
      const promptInput = document.getElementById("prompt-input");
      const submitButton = document.getElementById("submit-button");
      const chatLog = document.getElementById("chat-log");
      const statusDiv = document.getElementById("status");

      const backendBaseUrl = "http://localhost:3001";

      const chatApiUrl = `${backendBaseUrl}/api/generate`;
      const dateTimeApiUrl = `${backendBaseUrl}/api/datetime`;
      const logApiUrl = `${backendBaseUrl}/api/log-connection`;
      const rankingApiUrl = `${backendBaseUrl}/api/ranking/registrar-acesso-bot`;

      const CHAT_HISTORY_KEY = "luna_chat_history_v002";

      console.log("--- [FRONTEND] Script iniciado ---");

      async function registrarConexaoUsuario() {
        console.log("[FRONTEND] Tentando registrar conex칚o do usu치rio...");
        try {
          const response = await fetch(logApiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ acao: "acesso_inicial_chatbot" }),
          });
          if (!response.ok) {
            const errorData = await response.json();
            console.error(
              "Falha ao registrar log de conex칚o:",
              errorData.error
            );
          } else {
            const result = await response.json();
            console.log(
              "Log de conex칚o registrado com sucesso:",
              result.message
            );
          }
        } catch (error) {
          console.error(
            "Erro de rede ao tentar registrar log de conex칚o:",
            error
          );
        }
      }

      async function registrarAcessoBotParaRanking(botId, nomeBot) {
        console.log(
          `[FRONTEND] Tentando registrar acesso para ranking do bot: ${nomeBot}`
        );
        try {
          const response = await fetch(rankingApiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ botId: botId, nomeBot: nomeBot }),
          });
          if (!response.ok) {
            const errorData = await response.json();
            console.error(
              "Falha ao registrar acesso para ranking:",
              errorData.error
            );
          } else {
            const result = await response.json();
            console.log(
              "Acesso para ranking registrado com sucesso:",
              result.message
            );
          }
        } catch (error) {
          console.error(
            "Erro de rede ao tentar registrar acesso para ranking:",
            error
          );
        }
      }

      function formatTime(dateString) {
        const date = dateString ? new Date(dateString) : new Date();
        return date.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      }

      async function fetchAndDisplayInitialDateTime() {
        console.log("[FRONTEND] Buscando data/hora inicial...");
        try {
          const response = await fetch(dateTimeApiUrl);
          if (!response.ok)
            throw new Error(`Erro ${response.status} ao buscar data/hora.`);
          const data = await response.json();
          const dateTimeMessage = `Hoje 칠 ${data.datetime} 游눗`;
          const dateTimeDiv = document.createElement("div");
          dateTimeDiv.classList.add("initial-date-time");
          dateTimeDiv.textContent = dateTimeMessage;
          chatLog.appendChild(dateTimeDiv);
        } catch (error) {
          console.error("[FRONTEND] Falha ao buscar data/hora:", error);
          const errorDiv = document.createElement("div");
          errorDiv.classList.add("initial-date-time");
          errorDiv.style.color = "red";
          errorDiv.textContent =
            "N칚o consegui ver a data e hora agora, amor... 游땩";
          chatLog.appendChild(errorDiv);
        }
      }

      // CORRE칂츾O: Fun칞칚o de salvar no LocalStorage implementada
      function saveMessageToLocalStorage(sender, text) {
        try {
          const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
          const history = savedHistory ? JSON.parse(savedHistory) : [];
          history.push({ sender, text, timestamp: new Date().toISOString() });

          // Limitar o hist칩rico para n칚o sobrecarregar o localStorage
          if (history.length > 50) {
            history.splice(0, history.length - 50);
          }

          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.error("Falha ao salvar mensagem no LocalStorage:", e);
        }
      }

      function addMessageToLog(
        sender,
        message,
        saveToHistory = true,
        timestamp
      ) {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("message-container");

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");

        if (sender === "user") {
          messageContainer.classList.add("user-message-container");
          messageDiv.classList.add("user-message");
        } else if (sender === "ai") {
          messageContainer.classList.add("ai-message-container");
          messageDiv.classList.add("ai-message");
        } else if (sender === "error") {
          messageContainer.classList.add("error-message-container");
          messageDiv.classList.add("error-message");
        }

        messageDiv.textContent = message;
        messageContainer.appendChild(messageDiv);

        if (sender !== "error") {
          const timeDiv = document.createElement("div");
          timeDiv.classList.add("message-time");
          timeDiv.textContent = formatTime(timestamp);
          messageContainer.appendChild(timeDiv);
        }

        chatLog.appendChild(messageContainer);
        chatLog.scrollTop = chatLog.scrollHeight;

        if (saveToHistory && (sender === "user" || sender === "ai")) {
          saveMessageToLocalStorage(sender, message);
        }
      }

      async function loadChatHistory() {
        console.log("[FRONTEND] Iniciando carregamento do hist칩rico...");
        chatLog.innerHTML = "";
        await fetchAndDisplayInitialDateTime();

        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);

        if (!savedHistory) {
          console.log(
            "[FRONTEND] Nenhum hist칩rico encontrado. Exibindo mensagem de boas-vindas."
          );
          addMessageToLog(
            "ai",
            "Oi, meu amor! 游봃 Que bom te ver por aqui! Como voc칡 t치 hoje?",
            true
          ); // Salvar a primeira mensagem
          return;
        }

        try {
          const history = JSON.parse(savedHistory);
          console.log(
            `[FRONTEND] Carregando ${history.length} mensagens do hist칩rico.`
          );
          history.forEach((msg) => {
            addMessageToLog(msg.sender, msg.text, false, msg.timestamp);
          });
        } catch (e) {
          console.error("[FRONTEND] Erro ao carregar hist칩rico. Limpando.", e);
          localStorage.removeItem(CHAT_HISTORY_KEY);
          addMessageToLog(
            "ai",
            "Oi, meu amor! 游봃 Tivemos um probleminha para carregar nosso hist칩rico, mas j치 estou aqui de novo!",
            true
          );
        }
      }

      // Gerar sessionId 칰nico no carregamento da p치gina
      const sessionId = `sess-${Date.now()}-${Math.random()
        .toString(36)
        .substr(2, 6)}`;

      localStorage.setItem("chat_session_id", sessionId);

      // Fun칞칚o para salvar sess칚o ao sair/atualizar
      async function salvarSessaoChat() {
        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        if (!savedHistory) return;

        try {
          const history = JSON.parse(savedHistory);
          await fetch(`${backendBaseUrl}/api/chat/save-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sessionId,
              messages: history,
              userIP: "detected-ip", // Ser치 preenchido pelo backend
            }),
          });
          console.log("Sess칚o salva com sucesso!");
        } catch (error) {
          console.error("Erro ao salvar sess칚o:", error);
        }
      }

      // Event listeners para salvar ao sair
      window.addEventListener("beforeunload", salvarSessaoChat);
      window.addEventListener("pagehide", salvarSessaoChat);

      promptInput.addEventListener("input", () => {
        // Auto-ajuste da altura do textarea
        promptInput.style.height = "auto";
        promptInput.style.height = promptInput.scrollHeight + "px";
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) return;

        addMessageToLog("user", userPrompt, true);

        const savedRawHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        let historyForAPI = [];
        if (savedRawHistory) {
          try {
            // A API precisa do hist칩rico ANTES da mensagem atual.
            const parsedHistory = JSON.parse(savedRawHistory);
            historyForAPI = parsedHistory.slice(0, -1).map((m) => ({
              sender: m.sender,
              text: m.text,
            }));
          } catch (e) {
            console.error("Erro ao parsear hist칩rico para API", e);
            historyForAPI = [];
          }
        }

        // Limita o hist칩rico enviado para a API para otimizar a requisi칞칚o
        if (historyForAPI.length > 40) {
          historyForAPI = historyForAPI.slice(-40);
        }

        promptInput.value = "";
        promptInput.style.height = "40px"; // Reseta altura
        submitButton.disabled = true;
        statusDiv.textContent = "Luna est치 digitando... 游눬";

        try {
          const response = await fetch(chatApiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: userPrompt,
              history: historyForAPI,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            // Usa a mensagem de erro vinda do backend, que 칠 mais amig치vel
            throw new Error(data.error || `Erro ${response.status}`);
          }

          if (data.generatedText) {
            addMessageToLog("ai", data.generatedText, true);
          } else {
            throw new Error(
              "Recebi uma resposta, mas n칚o consegui extrair o texto. 游뱂"
            );
          }
        } catch (error) {
          console.error(
            "[FRONTEND] Erro na requisi칞칚o para /api/generate:",
            error
          );
          addMessageToLog("error", error.message, false);
        } finally {
          submitButton.disabled = false;
          statusDiv.textContent = "";
          promptInput.focus();
        }
      });

      async function salvarSessaoChat() {
        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        if (!savedHistory) return;

        try {
          const history = JSON.parse(savedHistory);

          // Obter IP do usu치rio (simplificado)
          let userIP = "desconhecido";
          try {
            const ipResponse = await fetch("https://api.ipify.org?format=json");
            const ipData = await ipResponse.json();
            userIP = ipData.ip;
          } catch (ipError) {
            console.warn("N칚o foi poss칤vel obter IP:", ipError);
          }

          await fetch(`${backendBaseUrl}/api/chat/save-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sessionId,
              messages: history,
              userIP,
            }),
          });
          console.log("Sess칚o salva com sucesso!");
        } catch (error) {
          console.error("Erro ao salvar sess칚o:", error);
        }
      }

      // Salvar sess칚o quando o usu치rio sair
      window.addEventListener("beforeunload", salvarSessaoChat);
      window.addEventListener("pagehide", salvarSessaoChat);

      // Salvar periodicamente a cada 2 minutos (opcional)
      setInterval(salvarSessaoChat, 120000);

      // CORRE칂츾O: Centralizando toda a l칩gica de inicializa칞칚o aqui.
      window.addEventListener("load", () => {
        console.log("[FRONTEND] P치gina carregada. Iniciando rotinas...");

        // 1. Carrega o hist칩rico de chat da mem칩ria do navegador
        loadChatHistory();

        // 2. Registra a conex칚o no log oficial (MongoDB)
        registrarConexaoUsuario();

        // 3. Registra o acesso para o ranking (Simulado no backend)
        registrarAcessoBotParaRanking("luna-namoradeira", "Luna");
      });

      console.log("--- [FRONTEND] Script finalizado (setup inicial) ---");
    </script>
  </body>
</html>
