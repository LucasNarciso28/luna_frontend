<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat com Luna </title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="chat-container">
      <h1>Conversando com Luna </h1>

      <div id="chat-log"></div>

      <section id="historico-container" style="display: none">
        <h2>Hist贸rico de Conversas </h2>
        <ul id="lista-sessoes"></ul>
        <div
          id="visualizacao-conversa-detalhada"
          style="margin-top: 20px"
        ></div>
      </section>

      <div class="botoes-topo">
        <button id="btn-historico">Ver Hist贸rico</button>
        <button id="btn-voltar-chat" style="display: none">
          Voltar ao Chat
        </button>
      </div>

      <div id="status"></div>

      <form id="prompt-form" style="width: 100%">
        <div id="input-area">
          <textarea
            id="prompt-input"
            rows="1"
            placeholder="Digite sua mensagem..."
          ></textarea>
          <button id="submit-button" type="submit">Enviar</button>
        </div>
      </form>
    </div>

    <script>
      // --- ELEMENTOS DO DOM ---
      const form = document.getElementById("prompt-form");
      const promptInput = document.getElementById("prompt-input");
      const submitButton = document.getElementById("submit-button");
      const chatLog = document.getElementById("chat-log");
      const statusDiv = document.getElementById("status");
      const historicoContainer = document.getElementById("historico-container");
      const listaSessoes = document.getElementById("lista-sessoes");
      const conversaDetalhadaContainer = document.getElementById("visualizacao-conversa-detalhada");
      const btnHistorico = document.getElementById("btn-historico");
      const btnVoltarChat = document.getElementById("btn-voltar-chat");

      // --- CONFIGURAES ---
      const backendBaseUrl = "http://localhost:3001";
      const CHAT_HISTORY_KEY = "luna_chat_history_v004"; // Incrementei para garantir que n茫o use cache antigo
      const SESSION_ID_KEY = "luna_session_id";

      // --- FUNES ---

      function getSessionId() {
        let sessionId = localStorage.getItem(SESSION_ID_KEY);
        if (!sessionId) {
          sessionId = `sess-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          localStorage.setItem(SESSION_ID_KEY, sessionId);
        }
        return sessionId;
      }

      const sessionId = getSessionId();

      function formatTime(dateString) {
        const date = dateString ? new Date(dateString) : new Date();
        return date.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", hour12: false });
      }

      function addMessageToLog(sender, message, saveToStorage = true, timestamp) {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("message-container");

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");

        if (sender === "user") {
          messageContainer.classList.add("user-message-container");
          messageDiv.classList.add("user-message");
        } else if (sender === "ai") {
          messageContainer.classList.add("ai-message-container");
          messageDiv.classList.add("ai-message");
        } else if (sender === "error") {
          messageContainer.classList.add("error-message-container");
          messageDiv.classList.add("error-message");
        }

        messageDiv.textContent = message;
        messageContainer.appendChild(messageDiv);

        if (sender !== "error") {
          const timeDiv = document.createElement("div");
          timeDiv.classList.add("message-time");
          timeDiv.textContent = formatTime(timestamp);
          messageContainer.appendChild(timeDiv);
        }

        chatLog.appendChild(messageContainer);
        chatLog.scrollTop = chatLog.scrollHeight;

        if (saveToStorage && (sender === "user" || sender === "ai")) {
          saveMessageToLocalStorage(sender, message);
        }
      }

      function saveMessageToLocalStorage(sender, text) {
        try {
          const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
          const history = savedHistory ? JSON.parse(savedHistory) : [];
          history.push({ sender, text, timestamp: new Date().toISOString() });
          if (history.length > 50) history.splice(0, history.length - 50);
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.error("Falha ao salvar mensagem no LocalStorage:", e);
        }
      }

      async function fetchAndDisplayInitialDateTime() {
        try {
          const response = await fetch(`${backendBaseUrl}/api/datetime`);
          if (!response.ok) throw new Error(`Erro ${response.status}`);
          const data = await response.json();
          const dateTimeDiv = document.createElement("div");
          dateTimeDiv.classList.add("initial-date-time");
          dateTimeDiv.textContent = `Hoje 茅 ${data.datetime} `;
          chatLog.appendChild(dateTimeDiv);
        } catch (error) {
          console.error("Falha ao buscar data/hora:", error);
        }
      }

      async function loadChatHistoryFromStorage() {
        console.log("[FRONTEND] Carregando hist贸rico do LocalStorage...");
        chatLog.innerHTML = "";
        await fetchAndDisplayInitialDateTime();

        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        if (!savedHistory) {
          addMessageToLog("ai", "Oi, meu amor! グ Que bom te ver por aqui! Como voc锚 t谩 hoje?", true);
          return;
        }
        try {
          const history = JSON.parse(savedHistory);
          history.forEach((msg) => addMessageToLog(msg.sender, msg.text, false, msg.timestamp));
        } catch (e) {
          console.error("Erro ao carregar hist贸rico do LocalStorage. Limpando.", e);
          localStorage.removeItem(CHAT_HISTORY_KEY);
          addMessageToLog("ai", "Tive um probleminha para carregar nosso hist贸rico, mas j谩 estou aqui!", true);
        }
      }

      async function salvarSessaoChat() {
        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        if (!savedHistory) {
          return;
        }

        try {
          const messages = JSON.parse(savedHistory);
          if (!Array.isArray(messages) || messages.length === 0) {
            return;
          }

          await fetch(`${backendBaseUrl}/api/chat/save-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId, messages }),
          });
          console.log("[FRONTEND] Sess茫o sincronizada com o backend.");
        } catch (error) {
          console.error("[FRONTEND] Erro ao tentar salvar sess茫o no backend:", error);
        }
      } // <--- ESTA CHAVE FALTAVA

      // --- LGICA DE VISUALIZAO DE HISTRICO ---

      async function carregarHistoricoSessoes() {
        try {
          const response = await fetch(`${backendBaseUrl}/api/chat/historicos`);
          if (!response.ok) throw new Error(`Erro ${response.status}`);
          const sessoes = await response.json();

          listaSessoes.innerHTML = "";
          conversaDetalhadaContainer.innerHTML = "";

          if (sessoes.length === 0) {
            listaSessoes.innerHTML = "<li>Nenhuma conversa encontrada.</li>";
            return;
          }

          sessoes.forEach((sessao) => {
            const li = document.createElement("li");
            const data = new Date(sessao.startTime).toLocaleString("pt-BR");
            li.textContent = `Conversa de ${data} (${sessao.messageCount} msgs)`;
            li.style.cursor = "pointer";
            li.dataset.sessionId = sessao.sessionId;

            li.addEventListener("click", () => exibirConversaDetalhada(sessao.sessionId));
            listaSessoes.appendChild(li);
          });
        } catch (error) {
          console.error("Erro ao carregar hist贸rico:", error);
          listaSessoes.innerHTML = "<li>Erro ao carregar o hist贸rico. </li>";
        }
      }

      async function exibirConversaDetalhada(sessionIdToFetch) {
        try {
          const response = await fetch(`${backendBaseUrl}/api/chat/historicos/${sessionIdToFetch}`);
          if (!response.ok) throw new Error(`Erro ${response.status}`);
          const sessionDetails = await response.json();
          const { messages } = sessionDetails;

          conversaDetalhadaContainer.innerHTML = "<h3>Detalhes da Conversa</h3>";

          messages.forEach((msg) => {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message-container", msg.sender === "user" ? "user-message-container" : "ai-message-container");

            const textDiv = document.createElement("div");
            textDiv.classList.add("message", msg.sender === "user" ? "user-message" : "ai-message");
            textDiv.textContent = msg.text;

            msgDiv.appendChild(textDiv);
            conversaDetalhadaContainer.appendChild(msgDiv);
          });
        } catch (error) {
          console.error("Erro ao buscar detalhes da conversa:", error);
          conversaDetalhadaContainer.innerHTML = "<h3>N茫o foi poss铆vel carregar os detalhes.</h3>";
        }
      }

      // --- EVENT LISTENERS ---

      btnHistorico.addEventListener("click", () => {
        historicoContainer.style.display = "block";
        chatLog.style.display = "none";
        btnHistorico.style.display = "none";
        btnVoltarChat.style.display = "inline-block";
        carregarHistoricoSessoes();
      });

      btnVoltarChat.addEventListener("click", () => {
        historicoContainer.style.display = "none";
        chatLog.style.display = "block";
        btnHistorico.style.display = "inline-block";
        btnVoltarChat.style.display = "none";
      });

      promptInput.addEventListener("input", () => {
        promptInput.style.height = "auto";
        promptInput.style.height = promptInput.scrollHeight + "px";
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) return;

        addMessageToLog("user", userPrompt, true);

        const savedRawHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        let historyForAPI = [];
        if (savedRawHistory) {
          try {
            const parsedHistory = JSON.parse(savedRawHistory);
            historyForAPI = parsedHistory.slice(0, -1);
          } catch (e) {
            console.error("Erro ao parsear hist贸rico para API", e);
          }
        }

        if (historyForAPI.length > 40) historyForAPI = historyForAPI.slice(-40);

        promptInput.value = "";
        promptInput.style.height = "auto";
        submitButton.disabled = true;
        statusDiv.textContent = "Luna est谩 digitando... ";

        try {
          const response = await fetch(`${backendBaseUrl}/api/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: userPrompt, history: historyForAPI }),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || `Erro ${response.status}`);
          addMessageToLog("ai", data.generatedText, true);
        } catch (error) {
          addMessageToLog("error", error.message, false);
        } finally {
          submitButton.disabled = false;
          statusDiv.textContent = "";
          promptInput.focus();
        }
      });

      // --- ROTINAS DE INICIALIZAO E CICLO DE VIDA ---

      window.addEventListener("load", () => {
        loadChatHistoryFromStorage();

        fetch(`${backendBaseUrl}/api/log-connection`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ acao: "acesso_inicial_chatbot" }),
        }).catch(err => console.error("Erro ao registrar log de conex茫o:", err));

        fetch(`${backendBaseUrl}/api/ranking/registrar-acesso-bot`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ botId: "luna-namoradeira", nomeBot: "Luna" }),
        }).catch(err => console.error("Erro ao registrar acesso para ranking:", err));
      });

      window.addEventListener("beforeunload", salvarSessaoChat);
      window.addEventListener("pagehide", salvarSessaoChat);
      setInterval(salvarSessaoChat, 60000);
    </script>
  </body>
</html>