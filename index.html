<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat com Luna 游눘</title>
    <style>
      /* ... (CSS permanece o mesmo) ... */
      body {
        font-family: sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 0;
        background-color: #f0e4f7;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      #chat-container {
        width: 90%;
        max-width: 600px;
        height: 85vh;
        max-height: 700px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      h1 {
        text-align: center;
        color: #6a0dad;
        padding: 15px;
        margin: 0;
        background-color: #e6ccff;
        border-bottom: 1px solid #d1b3e6;
        font-size: 1.4em;
      }

      #chat-log {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .message {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 100%;
        word-wrap: break-word;
      }

      .user-message {
        background-color: #d1b3e6;
        color: #333;
        border-bottom-right-radius: 5px;
      }

      .ai-message {
        background-color: #e6ccff;
        color: #333;
        border-bottom-left-radius: 5px;
      }

      .error-message {
        background-color: #ffdddd;
        color: #d8000c;
        font-style: italic;
        text-align: center;
        border: 1px solid #ffbaba;
      }

      #input-area {
        display: flex;
        padding: 10px;
        border-top: 1px solid #d1b3e6;
        background-color: #f8f0ff;
      }

      #prompt-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 20px;
        margin-right: 10px;
        font-size: 1rem;
        resize: none;
        height: 40px;
        line-height: 1.4;
      }

      #submit-button {
        padding: 10px 20px;
        background-color: #8a2be2;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease;
      }

      #submit-button:hover {
        background-color: #6a0dad;
      }

      #submit-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      #status {
        text-align: center;
        padding: 5px;
        font-size: 0.9em;
        color: #666;
        height: 1.2em;
      }

      .message-container {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        margin-bottom: 10px;
      }

      .user-message-container {
        align-self: flex-end;
      }

      .ai-message-container {
        align-self: flex-start;
      }

      .error-message-container {
        align-self: center;
        width: 90%;
      }

      .message {
        padding: 10px 15px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.4;
      }

      .user-message {
        background-color: #d1b3e6;
        color: #333;
        border-bottom-right-radius: 5px;
      }

      .ai-message {
        background-color: #e6ccff;
        color: #333;
        border-bottom-left-radius: 5px;
      }

      .error-message {
        background-color: #ffdddd;
        color: #d8000c;
        font-style: italic;
        text-align: center;
        border: 1px solid #ffbaba;
        border-radius: 8px;
      }

      .message-time {
        font-size: 0.7em;
        color: #888;
        margin-top: 4px;
      }

      .user-message-container .message-time {
        align-self: flex-end;
        color: #a67fcf;
      }

      .ai-message-container .message-time {
        align-self: flex-end;
        color: #c299e6;
      }

      .error-message-container .message-time {
        display: none;
      }

      .initial-date-time {
        font-size: 0.8em;
        color: #777;
        text-align: center;
        margin: 10px 0;
        font-style: italic;
      }
    </style>
  </head>

  <body>
    <div id="chat-container">
      <h1>Conversando com Luna 游눘</h1>
      <div id="chat-log"></div>
      <div id="status"></div>
      <form id="prompt-form" style="width: 100%">
        <div id="input-area">
          <textarea
            id="prompt-input"
            rows="1"
            placeholder="Digite sua mensagem..."
          ></textarea>
          <button id="submit-button" type="submit">Enviar</button>
        </div>
      </form>
    </div>

    <script>
    const form = document.getElementById("prompt-form");
    const promptInput = document.getElementById("prompt-input");
    const submitButton = document.getElementById("submit-button");
    const chatLog = document.getElementById("chat-log");
    const statusDiv = document.getElementById("status");

    const backendBaseUrl = "https://luna-botnamoradeiro.onrender.com";

    const chatApiUrl = `${backendBaseUrl}/api/generate`;
    const dateTimeApiUrl = `${backendBaseUrl}/api/datetime`;
    const logApiUrl = `${backendBaseUrl}/api/log-connection`;
    const rankingApiUrl = `${backendBaseUrl}/api/ranking/registrar-acesso-bot`;

    const CHAT_HISTORY_KEY = "luna_chat_history_v002";

    console.log("--- [FRONTEND] Script iniciado ---");

    async function registrarConexaoUsuario() {
        console.log("[FRONTEND] Tentando registrar conex칚o do usu치rio...");
        try {
            const response = await fetch(logApiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ acao: "acesso_inicial_chatbot" }),
            });
            if (!response.ok) {
                const errorData = await response.json();
                console.error("Falha ao registrar log de conex칚o:", errorData.error);
            } else {
                const result = await response.json();
                console.log("Log de conex칚o registrado com sucesso:", result.message);
            }
        } catch (error) {
            console.error("Erro de rede ao tentar registrar log de conex칚o:", error);
        }
    }

    async function registrarAcessoBotParaRanking(botId, nomeBot) {
        console.log(`[FRONTEND] Tentando registrar acesso para ranking do bot: ${nomeBot}`);
        try {
            const response = await fetch(rankingApiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ botId: botId, nomeBot: nomeBot }),
            });
            if (!response.ok) {
                const errorData = await response.json();
                console.error("Falha ao registrar acesso para ranking:", errorData.error);
            } else {
                const result = await response.json();
                console.log("Acesso para ranking registrado com sucesso:", result.message);
            }
        } catch (error) {
            console.error("Erro de rede ao tentar registrar acesso para ranking:", error);
        }
    }

    function formatTime(date = new Date()) {
        return date.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", hour12: false });
    }

    async function fetchAndDisplayInitialDateTime() {
        console.log("[FRONTEND] Buscando data/hora inicial...");
        try {
            const response = await fetch(dateTimeApiUrl);
            if (!response.ok) throw new Error(`Erro ${response.status} ao buscar data/hora.`);
            const data = await response.json();
            const dateTimeMessage = `Hoje 칠 ${data.datetime} 游눗`;
            const dateTimeDiv = document.createElement("div");
            dateTimeDiv.classList.add("initial-date-time");
            dateTimeDiv.textContent = dateTimeMessage;
            chatLog.appendChild(dateTimeDiv);
        } catch (error) {
            console.error("[FRONTEND] Falha ao buscar data/hora:", error);
            const errorDiv = document.createElement("div");
            errorDiv.classList.add("initial-date-time");
            errorDiv.style.color = "red";
            errorDiv.textContent = "N칚o consegui ver a data e hora agora, amor... 游땩";
            chatLog.appendChild(errorDiv);
        }
    }

    function addMessageToLog(sender, message, saveToHistory = true) {
        /* Seu c칩digo original aqui, est치 correto */
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');
        if (sender === 'user') {
            messageDiv.classList.add('user-message');
            messageContainer.classList.add('user-message-container');
        } else if (sender === 'ai') {
            messageDiv.classList.add('ai-message');
            messageContainer.classList.add('ai-message-container');
        } else if (sender === 'error') {
            messageDiv.classList.add('error-message');
            messageContainer.classList.add('error-message-container');
        }
        messageDiv.textContent = message;
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time');
        timeDiv.textContent = formatTime();
        messageContainer.appendChild(messageDiv);
        if (sender !== 'error') {
            messageContainer.appendChild(timeDiv);
        }
        chatLog.appendChild(messageContainer);
        chatLog.scrollTop = chatLog.scrollHeight;
        if (saveToHistory && (sender === 'user' || sender === 'ai')) {
            saveMessageToLocalStorage(sender, message);
        }
    }

    function saveMessageToLocalStorage(sender, text) { /* Seu c칩digo original aqui, est치 correto */ }
    
    async function loadChatHistory() {
        console.log("[FRONTEND] Iniciando carregamento do hist칩rico...");
        chatLog.innerHTML = "";
        await fetchAndDisplayInitialDateTime();
        const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        if (!savedHistory) {
            addMessageToLog("ai", "Oi, meu amor! 游봃 Que bom te ver por aqui! Como voc칡 t치 hoje?", false);
            return;
        }
        try {
            const history = JSON.parse(savedHistory);
            history.forEach((msg) => addMessageToLog(msg.sender, msg.text, false));
        } catch (e) {
            localStorage.removeItem(CHAT_HISTORY_KEY);
            addMessageToLog("ai", "Oi, meu amor! 游봃 Tivemos um probleminha, mas j치 estou aqui!", false);
        }
    }

    promptInput.addEventListener("input", () => { /* Seu c칩digo original aqui, est치 correto */ });

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const userPrompt = promptInput.value.trim();
        if (!userPrompt) return;
        addMessageToLog("user", userPrompt, true);
        const savedRawHistory = localStorage.getItem(CHAT_HISTORY_KEY);
        let historyForAPI = [];
        if (savedRawHistory) {
            const parsedHistory = JSON.parse(savedRawHistory);
            historyForAPI = parsedHistory.slice(0, -1).map((m) => ({ sender: m.sender, text: m.text }));
        }
        if (historyForAPI.length > 40) historyForAPI = historyForAPI.slice(-40);
        promptInput.value = "";
        promptInput.style.height = "40px";
        submitButton.disabled = true;
        statusDiv.textContent = "Luna est치 digitando... 游눬";

        try {
            // CORRE칂츾O: Usando a vari치vel correta 'chatApiUrl'
            const response = await fetch(chatApiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: userPrompt, history: historyForAPI }),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Erro ${response.status}`);
            if (data.generatedText) {
                addMessageToLog("ai", data.generatedText, true);
            } else {
                addMessageToLog("ai", "Recebi uma resposta, mas n칚o consegui extrair o texto. 游뱂", true);
            }
        } catch (error) {
            addMessageToLog("error", error.message, false);
        } finally {
            submitButton.disabled = false;
            statusDiv.textContent = "";
            promptInput.focus();
        }
    });

    // CORRE칂츾O: Centralizando toda a l칩gica de inicializa칞칚o aqui.
    window.addEventListener('load', () => {
        console.log("[FRONTEND] P치gina carregada. Iniciando rotinas...");

        // 1. Carrega o hist칩rico de chat
        loadChatHistory();

        // 2. Registra a conex칚o no log oficial
        registrarConexaoUsuario();

        // 3. Registra o acesso para o ranking
        registrarAcessoBotParaRanking("luna-namorada", "Luna");
    });

    console.log("--- [FRONTEND] Script finalizado (setup inicial) ---");
</script>
  </body>
</html>
